----------------COMANDOS CREATE---------------------

--TABLA TEMPORAL-----------------------------------
CREATE TABLE temp{
    Nombre_Victima VARCHAR2(50),
    Apellido_Victima VARCHAR2(50),
    Direccion_Victima VARCHAR2(100),
    Fecha_Sospecha DATE,
    Fecha_Confirmacion DATE,
    Fecha_Muerte DATE,
    Estado VARCHAR2(50);
    Nombre_Asociado VARCHAR2(50),
    Apellido_Asociado VARCHAR2(50),
    Fecha_Conocio DATE,
    Contacto VARCHAR2(50),
    Fecha_Inicio_Contacto DATE,
    Fecha_Final_Contacto DATE,
    Nombre_Hospital VARCHAR2(50),
    Direccion_Hospital VARCHAR2(100),
    Ubicacion_Victima VARCHAR2(100),
    Fecha_Llegada DATE,
    Fecha_Retiro DATE,
    Tratamiento VARCHAR2(50),
    Efectividad INT,
    Fecha_Inicio_Tratamiento DATE,
    Fecha_Final_Tratamiento DATE,
    Efectividad_Paciente INT
}


--TABLA VICTIMA-----------------------------------
CREATE TABLE VICTIMA(
    Id_Victima INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre_Victima VARCHAR2(50),
    Apellido_Victima VARCHAR2(50),
    Direccion_Victima VARCHAR2(100),
    Fecha_Sospecha DATE,
    Fecha_Confirmacion DATE,
    Fecha_Muerte DATE,
    Id_Hospital INT,
    CONSTRAINT fk_hospital_victima FOREIGN KEY (Id_Hospital) REFERENCES HOSPITAL(Id_Hospital),
    Estado VARCHAR2(50)
)


--TABLA HOSPITAL-----------------------------------
CREATE TABLE HOSPITAL (
    Id_Hospital INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre_Hospital VARCHAR2(100),
    Direccion_Hospital VARCHAR2(100)
)


--TABLA TRATAMIENTO-----------------------------------
CREATE TABLE TRATAMIENTO (
    Id_Tratamiento INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Tratamiento VARCHAR2(100),
    Efectividad INT
)


--TABLA TRATAMIENTO-----------------------------------
CREATE TABLE TRATAMIENTO (
    Id_Tratamiento INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Tratamiento VARCHAR2(100),
    Efectividad INT
)      


--TABLA TRATAMIENTO-----------------------------------
CREATE TABLE UBICACION (
    Id_Ubicacion INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Ubicacion_Victima VARCHAR2(100)
)    


--TABLA VICTIMA_UBICACION-----------------------------------
CREATE TABLE CREATE TABLE VICTIMA_UBICACION (
    Id_Ubicacion INT,
    CONSTRAINT fk_ubicacion_ubicacion FOREIGN KEY (Id_Ubicacion) REFERENCES UBICACION (Id_Ubicacion),
    Id_Victima INT,
    CONSTRAINT fk_victima_ubicacion FOREIGN KEY (Id_Victima) REFERENCES VICTIMA(Id_Victima),
    Fecha_Llegada DATE,
    Fecha_Retiro DATE
)


--TABLA VICTIMA_TRATAMIENTO-----------------------------------
CREATE TABLE VICTIMA_TRATAMIENTO (
    Id_Tratamiento INT,
    CONSTRAINT fk_tratamiento_tratamiento FOREIGN KEY (Id_Tratamiento) REFERENCES TRATAMIENTO(Id_Tratamiento),
    Id_Victima INT,
    CONSTRAINT fk_victima_tratamiento FOREIGN KEY (Id_Victima) REFERENCES VICTIMA (Id_Victima),
    Fecha_Inicio_Tratamiento DATE,
    Fecha_Final_Tratamiento DATE,
    Efectividad_Paciente INTEGER
)


--TABLA VICTIMA_ASOCIADO-----------------------------------
CREATE TABLE VICTIMA_ASOCIADO (
    Id_Asociado INT,
    CONSTRAINT fk_asociado_asociado FOREIGN KEY (Id_Asociado) REFERENCES ASOCIADO (Id_Asociado),
    Id_Victima INT,
    CONSTRAINT fk_victima_asociado FOREIGN KEY (Id_Victima) REFERENCES VICTIMA(Id_Victima),
    Fecha_Conocio DATE,
    Contacto VARCHAR2(50),
    Fecha_Inicio_Contacto DATE,
    Fecha_Final_Contacto DATE
)


----------------COMANDOS INSERT---------------------
--INSERT ASOCIADO-----------------------------------
INSERT INTO ASOCIADO (Nombre_Asociado , Apellido_Asociado) 
SELECT DISTINCT Nombre_Asociado , Apellido_Asociado 
FROM TEMP 
WHERE NOMBRE_ASOCIADO IS NOT NULL


--INSERT HOSPITAL-----------------------------------
INSERT INTO HOSPITAL (NOMBRE_HOSPITAL, DIRECCION_HOSPITAL)
SELECT DISTINCT NOMBRE_HOSPITAL, DIRECCION_HOSPITAL
FROM TEMP
WHERE NOMBRE_HOSPITAL IS NOT NULL


--INSERT UBICACION-----------------------------------
INSERT INTO UBICACION (UBICACION_VICTIMA)
SELECT DISTINCT UBICACION_VICTIMA
FROM TEMP
WHERE UBICACION_VICTIMA IS NOT NULL


--INSERT TRATAMIENTO-----------------------------------
INSERT INTO TRATAMIENTO (TRATAMIENTO , EFECTIVIDAD)
SELECT DISTINCT TRATAMIENTO , EFECTIVIDAD
FROM TEMP
WHERE TRATAMIENTO IS NOT NULL


--INSERT VICTIMA-----------------------------------
INSERT INTO VICTIMA (NOMBRE_VICTIMA, APELLIDO_VICTIMA,DIRECCION_VICTIMA,FECHA_SOSPECHA,FECHA_CONFIRMACION,FECHA_MUERTE,Id_Hospital,ESTADO)
SELECT DISTINCT NOMBRE_VICTIMA, APELLIDO_VICTIMA,DIRECCION_VICTIMA,FECHA_SOSPECHA,FECHA_CONFIRMACION,FECHA_MUERTE,Id_Hospital,ESTADO
FROM TEMP v INNER JOIN HOSPITAL h
ON v.NOMBRE_HOSPITAL  = h.NOMBRE_HOSPITAL

INSERT INTO VICTIMA (NOMBRE_VICTIMA, APELLIDO_VICTIMA,DIRECCION_VICTIMA,FECHA_SOSPECHA,FECHA_CONFIRMACION,FECHA_MUERTE,ESTADO)
SELECT DISTINCT NOMBRE_VICTIMA, APELLIDO_VICTIMA,DIRECCION_VICTIMA,FECHA_SOSPECHA,FECHA_CONFIRMACION,FECHA_MUERTE,ESTADO
FROM TEMP t 
WHERE t.NOMBRE_HOSPITAL is NULL


--INSERT ASOCIADO-----------------------------------
INSERT INTO VICTIMA_TRATAMIENTO (Id_Tratamiento,Id_Victima,Fecha_Inicio_Tratamiento, Fecha_Final_Tratamiento, Efectividad_Paciente)
SELECT DISTINCT ID_TRATAMIENTO, ID_VICTIMA, FECHA_INICIO_TRATAMIENTO, FECHA_FINAL_TRATAMIENTO, EFECTIVIDAD_PACIENTE
FROM VICTIMA v INNER JOIN (SELECT DISTINCT ID_TRATAMIENTO, FECHA_INICIO_TRATAMIENTO, FECHA_FINAL_TRATAMIENTO, EFECTIVIDAD_PACIENTE, NOMBRE_VICTIMA,APELLIDO_VICTIMA 
FROM TEMP t2  INNER JOIN TRATAMIENTO t
ON T.TRATAMIENTO  =T2.TRATAMIENTO) c
ON v.NOMBRE_VICTIMA = c.NOMBRE_VICTIMA AND v.APELLIDO_VICTIMA  = c.APELLIDO_VICTIMA


--INSERT ASOCIADO-----------------------------------
INSERT INTO VICTIMA_ASOCIADO (ID_ASOCIADO,ID_VICTIMA,FECHA_CONOCIO, CONTACTO, FECHA_INICIO_CONTACTO,FECHA_FINAL_CONTACTO)
SELECT DISTINCT ID_ASOCIADO, ID_VICTIMA, FECHA_CONOCIO, CONTACTO, FECHA_INICIO_CONTACTO,FECHA_FINAL_CONTACTO
FROM VICTIMA v INNER JOIN (SELECT DISTINCT ID_ASOCIADO, FECHA_CONOCIO, CONTACTO, FECHA_INICIO_CONTACTO,FECHA_FINAL_CONTACTO,NOMBRE_VICTIMA,APELLIDO_VICTIMA
FROM TEMP t2  INNER JOIN ASOCIADO a
ON a.NOMBRE_ASOCIADO  =T2.NOMBRE_ASOCIADO AND a.APELLIDO_ASOCIADO  = T2.APELLIDO_ASOCIADO) c
ON v.NOMBRE_VICTIMA = c.NOMBRE_VICTIMA AND v.APELLIDO_VICTIMA  = c.APELLIDO_VICTIMA


--INSERT ASOCIADO-----------------------------------
INSERT INTO VICTIMA_UBICACION (ID_UBICACION,ID_VICTIMA,FECHA_LLEGADA, FECHA_RETIRO)
SELECT DISTINCT ID_UBICACION, ID_VICTIMA, FECHA_LLEGADA, FECHA_RETIRO
FROM VICTIMA v INNER JOIN (SELECT DISTINCT ID_UBICACION, FECHA_LLEGADA, FECHA_RETIRO, NOMBRE_VICTIMA,APELLIDO_VICTIMA 
FROM TEMP t2  INNER JOIN UBICACION u
ON u.UBICACION_VICTIMA  =T2.UBICACION_VICTIMA) c
ON v.NOMBRE_VICTIMA = c.NOMBRE_VICTIMA AND v.APELLIDO_VICTIMA  = c.APELLIDO_VICTIMA




----------------CONSULTAS FINALES---------------------

--CONSULTA 1-----------------------------------
SELECT NOMBRE_HOSPITAL , DIRECCION_HOSPITAL , COUNT(v.ESTADO) AS num_fallecidos
FROM hospital h INNER JOIN victima v
ON h.ID_HOSPITAL  = v.id_hospital
WHERE v.FECHA_MUERTE IS NOT NULL 
GROUP BY NOMBRE_HOSPITAL, DIRECCION_HOSPITAL


--CONSULTA 2-----------------------------------
SELECT nombre_victima, apellido_victima
FROM VICTIMA v JOIN VICTIMA_TRATAMIENTO vt  
ON v.ID_VICTIMA  = vt.id_victima
JOIN TRATAMIENTO t ON vt.id_tratamiento = t.ID_TRATAMIENTO 
WHERE t.TRATAMIENTO  = 'Transfusiones de sangre'
AND vt.EFECTIVIDAD_PACIENTE > 5
AND v.ESTADO  = 'En cuarentena'


--CONSULTA 3-----------------------------------
SELECT NOMBRE_HOSPITAL , DIRECCION_HOSPITAL , COUNT(v.ESTADO) AS num_fallecidos
FROM hospital h INNER JOIN victima v
ON h.ID_HOSPITAL  = v.id_hospital
WHERE v.FECHA_MUERTE IS NOT NULL 
GROUP BY NOMBRE_HOSPITAL, DIRECCION_HOSPITAL


    --CONSULTA 4-----------------------------------
SELECT v.NOMBRE_VICTIMA, v.APELLIDO_VICTIMA
FROM VICTIMA v JOIN VICTIMA_ASOCIADO va 
ON v.ID_VICTIMA = va.ID_VICTIMA 
JOIN ASOCIADO a 
ON va.id_asociado = a.id_asociado
WHERE v.estado = 'Suspendida'
AND va.CONTACTO = 'Beso'
GROUP BY v.NOMBRE_VICTIMA, v.APELLIDO_VICTIMA
HAVING COUNT(DISTINCT va.id_asociado) > 2


--CONSULTA 5-----------------------------------
SELECT  v.NOMBRE_VICTIMA , v.APELLIDO_VICTIMA , COUNT(*) AS num_tratamientos 
FROM Victima v 
JOIN VICTIMA_TRATAMIENTO vt
ON v.ID_VICTIMA  = vt.ID_VICTIMA 
JOIN TRATAMIENTO t
ON t.ID_TRATAMIENTO  = vt.ID_TRATAMIENTO 
WHERE t.TRATAMIENTO  = 'Oxigeno'
GROUP BY v.ID_VICTIMA, v.NOMBRE_VICTIMA , v.APELLIDO_VICTIMA 
ORDER BY num_tratamientos DESC
FETCH FIRST 5 ROWS ONLY


--CONSULTA 6-----------------------------------
SELECT v.NOMBRE_VICTIMA , v.APELLIDO_VICTIMA , v.FECHA_MUERTE 
FROM Victima v JOIN VICTIMA_UBICACION vu 
ON v.ID_VICTIMA  = vu.id_victima
JOIN UBICACION u  ON vu.ID_UBICACION  = u.ID_UBICACION 
JOIN VICTIMA_TRATAMIENTO vt ON vt.ID_VICTIMA = v.ID_VICTIMA 
JOIN TRATAMIENTO t  ON t.ID_TRATAMIENTO  = vt.ID_TRATAMIENTO 
WHERE u.UBICACION_VICTIMA  = '1987 Delphine Well' AND t.TRATAMIENTO = 'Manejo de la presion arterial'


--CONSULTA 7-----------------------------------
SELECT v.NOMBRE_VICTIMA, v.APELLIDO_VICTIMA, v.DIRECCION_VICTIMA
FROM VICTIMA v 
JOIN VICTIMA_ASOCIADO va  ON v.ID_VICTIMA = va.id_victima
JOIN ASOCIADO a ON va.ID_ASOCIADO = a.ID_ASOCIADO
JOIN VICTIMA_TRATAMIENTO vt ON v.ID_VICTIMA  = vt.ID_VICTIMA 
JOIN TRATAMIENTO t ON vt.id_tratamiento = t.ID_TRATAMIENTO
WHERE v.ID_HOSPITAL IS NOT NULL
GROUP BY v.NOMBRE_VICTIMA, v.APELLIDO_VICTIMA, v.DIRECCION_VICTIMA
HAVING COUNT(a.ID_ASOCIADO) < 2 AND COUNT(vt.ID_TRATAMIENTO) = 2


--CONSULTA 8-----------------------------------
SELECT mes_sospecha, NOMBRE_VICTIMA, APELLIDO_VICTIMA, num_tratamientos
    FROM (
        SELECT EXTRACT(MONTH FROM V.FECHA_SOSPECHA) AS mes_sospecha, V.NOMBRE_VICTIMA, V.APELLIDO_VICTIMA, COUNT(*) AS num_tratamientos,
        RANK() OVER (ORDER BY COUNT(*) DESC) AS rnk_desc,
        RANK() OVER (ORDER BY COUNT(*) ASC) AS rnk_asc
        FROM VICTIMA v 
        JOIN VICTIMA_TRATAMIENTO vt ON v.ID_VICTIMA = vt.ID_VICTIMA 
        JOIN TRATAMIENTO t ON t.ID_TRATAMIENTO = vt.ID_TRATAMIENTO
        GROUP BY V.ID_VICTIMA, V.NOMBRE_VICTIMA, V.APELLIDO_VICTIMA, V.FECHA_SOSPECHA
    )subquery
WHERE rnk_desc = 1 OR rnk_asc = 1
ORDER BY num_tratamientos DESC


--CONSULTA 9-----------------------------------
SELECT h.NOMBRE_HOSPITAL , COUNT(*) * 100.0 / (SELECT COUNT(*) FROM VICTIMA v) AS porcentaje_victimas
FROM HOSPITAL h  
LEFT JOIN VICTIMA v2  ON h.ID_HOSPITAL  = v2.ID_HOSPITAL 
GROUP BY h.ID_HOSPITAL , h.NOMBRE_HOSPITAL
ORDER BY porcentaje_victimas ASC

--CONSULTA 10-----------------------------------



--CONSULTA CARGAR TEMP-----------------------------------
sqlldr userid=TEST/1234@34.125.71.222:1521/ORCL18 control=archivo.ctl


--CONSULTA ELIMINAR TEMP-----------------------------------
DROP TABLE TEMP


--CONSULTA ELIMINAR MODELO-----------------------------------
DROP TABLE VICTIMA_UBICACION

DROP TABLE VICTIMA_TRATAMIENTO

DROP TABLE VICTIMA_ASOCIADO

DROP TABLE VICTIMA

DROP TABLE TRATAMIENTO

DROP TABLE UBICACION

DROP TABLE HOSPITAL

DROP TABLE ASOCIADO

DROP TABLE ARREGLO